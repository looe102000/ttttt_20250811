<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>占卜解析資訊產生器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 增加一個細微的過渡效果 */
        textarea, button {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 font-sans">
    <div id="app" class="min-h-screen flex items-center justify-center p-4">
        <div class="container mx-auto w-full max-w-6xl bg-white/80 backdrop-blur-sm shadow-xl rounded-2xl p-6 md:p-10">
            
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 text-center">
                產生占卜解析資訊
            </h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 md:gap-8">
                
                <!-- 輸入區域 -->
                <div class="flex flex-col">
                    <label class="block mb-3 font-semibold text-gray-600 text-lg" for="inputArea">
                        輸入內容
                    </label>
                    <textarea 
                        id="inputArea" 
                        v-model="inputText"
                        rows="12" 
                        class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm resize-y mb-6 text-base" 
                        placeholder="請貼入 JSON 或 Base64 字串...">
                    </textarea>
                </div>
                
                <!-- 顯示區域 -->
                <div class="flex flex-col">
                    <label class="block mb-3 font-semibold text-gray-600 text-lg" for="outputArea">
                        顯示內容
                    </label>
                    <textarea 
                        id="outputArea" 
                        :value="outputText"
                        rows="12" 
                        class="w-full p-4 border border-dashed border-gray-400 rounded-lg bg-gray-50/50 resize-y mb-6 text-base" 
                        readonly>
                    </textarea>
                    
                    <button 
                        @click="copyToClipboard" 
                        :class="copyButtonClass"
                        class="w-full py-3 px-6 text-white rounded-lg hover:shadow-lg transition-all text-lg font-medium flex items-center justify-center gap-2">
                        
                        <!-- Copy Icon -->
                        <svg v-if="copyIcon === 'copy'" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <!-- Check Icon -->
                        <svg v-if="copyIcon === 'check'" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <!-- Fail Icon -->
                        <svg v-if="copyIcon === 'fail'" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        
                        {{ copyButtonText }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const inputText = ref('');
                const copyButtonText = ref('複製內容');
                const copyIcon = ref('copy'); // 'copy', 'check', 'fail'

                const copyButtonClass = computed(() => {
                    switch(copyIcon.value) {
                        case 'check': return 'bg-green-500 hover:bg-green-600';
                        case 'fail': return 'bg-red-500 hover:bg-red-600';
                        default: return 'bg-indigo-600 hover:bg-indigo-700';
                    }
                });

                // =================================================
                // 以下為核心邏輯，完全不作更動
                // =================================================
                const round_data = {
                    ver: "1.0",
                    rounds: [
                        { round: "一", card_back_background_image: "images/back3.jpg", card_face_background_image: "images/face10.jpg", totalCards: 14, drawCount: 2, texts: [ { key: "AA", front: "紫微", back: "主星" }, { key: "AB", front: "天機", back: "主星" }, { key: "AC", front: "太陽", back: "主星" }, { key: "AD", front: "武曲", back: "主星" }, { key: "AE", front: "天同", back: "主星" }, { key: "AF", front: "廉貞", back: "主星" }, { key: "AG", front: "天府", back: "主星" }, { key: "AH", front: "太陰", back: "主星" }, { key: "AI", front: "貪狼", back: "主星" }, { key: "AJ", front: "巨門", back: "主星" }, { key: "AK", front: "天相", back: "主星" }, { key: "AL", front: "天梁", back: "主星" }, { key: "AM", front: "七殺", back: "主星" }, { key: "AN", front: "破軍", back: "主星" } ] },
                        { round: "二", card_back_background_image: "images/back2.jpg", card_face_background_image: "images/face16.jpg", totalCards: 14, drawCount: 2, texts: [ { key: "BA", front: "文昌", back: "副星" }, { key: "BB", front: "文曲", back: "副星" }, { key: "BC", front: "左輔", back: "副星" }, { key: "BD", front: "右弼", back: "副星" }, { key: "BE", front: "天魁", back: "副星" }, { key: "BF", front: "天鉞", back: "副星" }, { key: "BG", front: "地空", back: "副星" }, { key: "BH", front: "地劫", back: "副星" }, { key: "BI", front: "火星", back: "副星" }, { key: "BJ", front: "鈴星", back: "副星" }, { key: "BK", front: "擎羊", back: "副星" }, { key: "BL", front: "陀羅", back: "副星" }, { key: "BM", front: "天馬", back: "副星" }, { key: "BN", front: "祿存", back: "副星" } ] },
                        { round: "三", card_back_background_image: "images/back1.jpg", card_face_background_image: "images/face17.jpg", totalCards: 32, drawCount: 3, texts: [ { key: "CA", front: "天官", back: "乙級星" }, { key: "CB", front: "天福", back: "乙級星" }, { key: "CC", front: "天廚", back: "乙級星" }, { key: "CD", front: "天刑", back: "乙級星" }, { key: "CE", front: "天姚", back: "乙級星" }, { key: "CF", front: "解神", back: "乙級星" }, { key: "CG", front: "天巫", back: "乙級星" }, { key: "CH", front: "天月", back: "乙級星" }, { key: "CI", front: "陰煞", back: "乙級星" }, { key: "CJ", front: "台輔", back: "乙級星" }, { key: "CK", front: "封誥", back: "乙級星" }, { key: "CL", front: "天空", back: "乙級星" }, { key: "CM", front: "天哭", back: "乙級星" }, { key: "CN", front: "天虛", back: "乙級星" }, { key: "CO", front: "龍池", back: "乙級星" }, { key: "CP", front: "鳳閣", back: "乙級星" }, { key: "CQ", front: "紅鸞", back: "乙級星" }, { key: "CR", front: "天喜", back: "乙級星" }, { key: "CS", front: "孤辰", back: "乙級星" }, { key: "CT", front: "寡宿", back: "乙級星" }, { key: "CU", front: "蜚廉", back: "乙級星" }, { key: "CV", front: "破碎", back: "乙級星" }, { key: "CW", front: "華蓋", back: "乙級星" }, { key: "CX", front: "咸池", back: "乙級星" }, { key: "CY", front: "天德", back: "乙級星" }, { key: "CZ", front: "月德", back: "乙級星" }, { key: "DA", front: "天才", back: "乙級星" }, { key: "DB", front: "天壽", back: "乙級星" }, { key: "DC", front: "三台", back: "乙級星" }, { key: "DD", front: "八座", back: "乙級星" }, { key: "DE", front: "恩光", back: "乙級星" }, { key: "DF", front: "天貴", back: "乙級星" } ] },
                        { round: "四", card_back_background_image: "images/back4.jpg", card_face_background_image: "images/face9.jpg", totalCards: 12, drawCount: 1, texts: [ { key: "EA", front: "長生", back: "宮位" }, { key: "EB", front: "沐浴", back: "宮位" }, { key: "EC", front: "冠帶", back: "宮位" }, { key: "ED", front: "臨官", back: "宮位" }, { key: "EE", front: "帝旺", back: "宮位" }, { key: "EF", front: "衰", back: "宮位" }, { key: "EG", front: "病", back: "宮位" }, { key: "EH", front: "死", back: "宮位" }, { key: "EI", front: "墓", back: "宮位" }, { key: "EJ", front: "絕", back: "宮位" }, { key: "EK", front: "胎", back: "宮位" }, { key: "EL", front: "養", back: "宮位" } ] }
                    ]
                };

                function decode(str) { try { return decodeURIComponent(str); } catch { return str; } }

                function parseResult(resultStr) {
                    let [ver, ...rest] = resultStr.split(';');
                    let rounds = [];
                    const locationMap = { '1': '巳', '2': '午', '3': '未', '4': '申', '5': '辰', '6': '酉', '7': '卯', '8': '戌', '9': '寅', '10': '丑', '11': '子', '12': '亥', 'center': '中間' };
                    if (rest.length > 0) {
                        let arr = rest.join(';').split('-');
                        for (let i = 0; i < arr.length; i += 2) {
                            let location = arr[i];
                            let key = arr[i + 1] || '';
                            let found = null;
                            let roundName = '';
                            for (const round of round_data.rounds) {
                                const text = round.texts.find(t => t.key === key);
                                if (text) {
                                    found = text;
                                    roundName = round.round;
                                    break;
                                }
                            }
                            let locationName = locationMap[location] || location;
                            if (found) {
                                rounds.push(`${location}-${key}: ${found.front} (${found.back}, 回合:${roundName}, 區域:${locationName})`);
                            } else {
                                rounds.push(`${location}-${key}: 未知 (區域:${locationName})`);
                            }
                        }
                    }
                    return { ver, rounds };
                }

                function convertToCustomFormat(parsedRounds) {
                    return parsedRounds.map((r, idx) => {
                        const match = r.match(/^(\w+)-(\w+): ([^ ]+) \([^,]+, 回合:[^,]+, 區域:([^\)]+)\)/);
                        if (match) {
                            return `${idx + 1}. ${match[3]}在${match[4]}`;
                        } else {
                            return `${idx + 1}. ${r}`;
                        }
                    }).join('\n');
                }

                function isBase64(str) {
                    return /^[A-Za-z0-9+\/=]+$/.test(str) && str.length % 4 === 0;
                }

                function buildOutput(obj) {
                    let output = '';
                    if (obj && obj.cus_info) {
                        const gender = decode(obj.cus_info.gender ?? '');
                        const cusName = decode(obj.cus_info.cus_name ?? '');
                        const subject = decode(obj.cus_info.subject ?? '');
                        const content = decode(obj.cus_info.content ?? '');
                        const divinationTime = decode(obj.cus_info.divination_time ?? '');
                        output += `時間：${divinationTime}\n`;
                        output += `類型：${subject}\n`;
                        output += `性別：${gender}\n`;
                        output += `姓名：${cusName}\n`;
                        output += `題目：${subject}\n\n`;
                        output += `問題概述:\n${content}\n\n`;
                    }
                    if (obj && obj.result) {
                        const result = parseResult(obj.result);
                        const body = convertToCustomFormat(result.rounds);
                        output += `抽牌呈現:\n\n${body}`;
                    }
                    return output || null;
                }

                const outputText = computed(() => {
                    const val = inputText.value.trim();
                    if (!val) return '';
                    let parsed = '';
                    if (val.startsWith('{')) {
                        try {
                            const obj = JSON.parse(val);
                            parsed = buildOutput(obj);
                        } catch {
                            parsed = 'JSON 解析失敗，請檢查格式。';
                        }
                    } else if (isBase64(val)) {
                        try {
                            const decoded = atob(val);
                            const obj = JSON.parse(decoded);
                            parsed = buildOutput(obj);
                        } catch {
                            parsed = 'Base64 解碼或解析失敗，請檢查內容。';
                        }
                    } else {
                        parsed = '無法識別的輸入格式。請提供 JSON 或 Base64。';
                    }
                    return parsed || '無法產生內容。';
                });
                
                // =================================================
                // 以上為核心邏輯，完全不作更動
                // =================================================

                const copyToClipboard = async () => {
                    if (!outputText.value) return;
                    try {
                        await navigator.clipboard.writeText(outputText.value);
                        copyButtonText.value = '已複製!';
                        copyIcon.value = 'check';
                    } catch (err) {
                        console.error('複製失敗:', err);
                        copyButtonText.value = '複製失敗';
                        copyIcon.value = 'fail';
                    } finally {
                        setTimeout(() => {
                            copyButtonText.value = '複製內容';
                            copyIcon.value = 'copy';
                        }, 1500);
                    }
                };

                return {
                    inputText,
                    outputText,
                    copyButtonText,
                    copyIcon,
                    copyButtonClass,
                    copyToClipboard
                };
            }
        }).mount('#app');
    </script>
</body>
</html>