<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>占卜解析資訊產生器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 增加一個細微的過渡效果 */
        textarea, button {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 font-sans">
    <div id="app" class="min-h-screen flex items-center justify-center p-4">
        <div class="container mx-auto w-full max-w-6xl bg-white/80 backdrop-blur-sm shadow-xl rounded-2xl p-6 md:p-10">
            
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 text-center">
                產生占卜解析資訊
            </h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 md:gap-8">
                
                <!-- 輸入區域 -->
                <div class="flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block font-semibold text-gray-600 text-lg" for="inputArea">
                            輸入內容
                        </label>
                        <button 
                            @click="clearInput"
                            class="px-4 py-1 text-sm text-white bg-gray-500 hover:bg-gray-600 rounded-lg transition-all flex items-center gap-1">
                            <!-- Clear Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            清除
                        </button>
                    </div>
                    <textarea 
                        id="inputArea" 
                        v-model="inputText"
                        rows="12" 
                        class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm resize-y mb-6 text-base" 
                        placeholder="請貼入 JSON、Base64 字串或中文格式內容...">
                    </textarea>
                </div>
                
                <!-- 顯示區域 -->
                <div class="flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block font-semibold text-gray-600 text-lg" for="outputArea">
                            顯示內容
                        </label>
                        <button 
                            @click="copyToClipboard" 
                            :class="copyButtonClass"
                            class="px-4 py-1 text-sm text-white rounded-lg transition-all flex items-center gap-1">
                            <!-- Copy Icon -->
                            <svg v-if="copyIcon === 'copy'" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <!-- Check Icon -->
                            <svg v-if="copyIcon === 'check'" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <!-- Fail Icon -->
                            <svg v-if="copyIcon === 'fail'" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            {{ copyButtonText }}
                        </button>
                    </div>
                    <textarea 
                        id="outputArea"
                        v-model="outputText"
                        rows="12" 
                        readonly
                        class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm resize-y mb-6 text-base bg-gray-50" 
                        placeholder="顯示解析後的內容...">
                    </textarea>
                </div>
            </div>

            <!-- Card Display Area -->
            <div id="card-display-area" v-if="Object.keys(gridCards).length > 0 || customerInfo" class="mt-10">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 text-center">
                    卡牌對應位置
                </h2>
                <div class="w-full max-w-3xl mx-auto p-2 md:p-4 rounded-lg">
                    <div class="grid grid-cols-4 grid-rows-4 gap-2 md:gap-4 text-center">
                        
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">巳</span>
                            <div v-if="gridCards['巳']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['巳']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">午</span>
                            <div v-if="gridCards['午']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['午']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">未</span>
                            <div v-if="gridCards['未']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['未']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">申</span>
                            <div v-if="gridCards['申']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['申']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">辰</span>
                            <div v-if="gridCards['辰']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['辰']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2 row-span-2 rounded-lg p-2 border-2 border-gray-400 flex flex-col justify-start">
                            <!-- Customer Info Display -->
                            <div v-if="customerInfo" class="text-xs mb-2 text-gray-800 text-left">
                                <div class="mb-1"><span class="font-bold">占卜時間:</span> {{ customerInfo.divination_time }}</div>
                                <div><span class="font-bold">性別:</span> {{ customerInfo.gender }}</div>
                                <div><span class="font-bold">姓名:</span> {{ customerInfo.cus_name }}</div>
                                <div><span class="font-bold">類型:</span> {{ customerInfo.subject }}</div>
                                <div class="mt-2">
                                    <div class="font-bold">問題概述:</div>
                                    <div class="border border-gray-400 rounded p-1 h-12 overflow-y-auto bg-gray-100">
                                        {{ customerInfo.content }}
                                    </div>
                                </div>
                            </div>

                            <!-- Cards in Center -->
                            <div v-if="gridCards['中間']" class="w-full text-center text-sm text-gray-800 mt-2">
                                <div class="text-center text-lg font-bold">中心卡牌</div>
                                <div v-for="card in gridCards['中間']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>

                            <!-- If nothing is in the center -->
                            <div v-if="!customerInfo && !gridCards['中間']" class="text-center text-xl font-bold text-gray-400 flex items-center justify-center h-full">
                                中心區域
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">酉</span>
                            <div v-if="gridCards['酉']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['酉']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">卯</span>
                            <div v-if="gridCards['卯']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['卯']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">戌</span>
                            <div v-if="gridCards['戌']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['戌']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">寅</span>
                            <div v-if="gridCards['寅']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['寅']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">丑</span>
                            <div v-if="gridCards['丑']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['丑']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">子</span>
                            <div v-if="gridCards['子']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['子']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-500 rounded-lg p-1 md:p-2 flex flex-col justify-start items-center h-auto min-h-[6rem] md:min-h-[7rem] border-2 border-dashed border-gray-400 text-gray-800">
                            <span class="text-xl md:text-2xl font-bold">亥</span>
                            <div v-if="gridCards['亥']" class="mt-1 text-xs md:text-sm w-full">
                                <div v-for="card in gridCards['亥']" :key="card.key" class="mb-1">
                                    <div class="font-semibold">{{ card.globalIndex }}. {{ card.front }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick } = Vue;

        createApp({
            setup() {
                const copyButtonText = ref('複製內容');
                const copyIcon = ref('copy'); // 'copy', 'check', 'fail'

                const copyButtonClass = computed(() => {
                    switch(copyIcon.value) {
                        case 'check': return 'bg-green-500 hover:bg-green-600';
                        case 'fail': return 'bg-red-500 hover:bg-red-600';
                        default: return 'bg-indigo-600 hover:bg-indigo-700';
                    }
                });

                const round_data = {
                    ver: "1.0",
                    rounds: [
                        { round: "一", card_back_background_image: "images/back3.jpg", card_face_background_image: "images/face10.jpg", totalCards: 14, drawCount: 2, texts: [ { key: "AA", front: "紫微", back: "主星" }, { key: "AB", front: "天機", back: "主星" }, { key: "AC", front: "太陽", back: "主星" }, { key: "AD", front: "武曲", back: "主星" }, { key: "AE", front: "天同", back: "主星" }, { key: "AF", front: "廉貞", back: "主星" }, { key: "AG", front: "天府", back: "主星" }, { key: "AH", front: "太陰", back: "主星" }, { key: "AI", front: "貪狼", back: "主星" }, { key: "AJ", front: "巨門", back: "主星" }, { key: "AK", front: "天相", back: "主星" }, { key: "AL", front: "天梁", back: "主星" }, { key: "AM", front: "七殺", back: "主星" }, { key: "AN", front: "破軍", back: "主星" } ] },
                        { round: "二", card_back_background_image: "images/back2.jpg", card_face_background_image: "images/face16.jpg", totalCards: 14, drawCount: 2, texts: [ { key: "BA", front: "文昌", back: "副星" }, { key: "BB", front: "文曲", back: "副星" }, { key: "BC", front: "左輔", back: "副星" }, { key: "BD", front: "右弼", back: "副星" }, { key: "BE", front: "天魁", back: "副星" }, { key: "BF", front: "天鉞", back: "副星" }, { key: "BG", front: "地空", back: "副星" }, { key: "BH", front: "地劫", back: "副星" }, { key: "BI", front: "火星", back: "副星" }, { key: "BJ", front: "鈴星", back: "副星" }, { key: "BK", front: "擎羊", back: "副星" }, { key: "BL", front: "陀羅", back: "副星" }, { key: "BM", front: "天馬", back: "副星" }, { key: "BN", front: "祿存", back: "副星" } ] },
                        { round: "三", card_back_background_image: "images/back1.jpg", card_face_background_image: "images/face17.jpg", totalCards: 32, drawCount: 3, texts: [ { key: "CA", front: "天官", back: "乙級星" }, { key: "CB", front: "天福", back: "乙級星" }, { key: "CC", front: "天廚", back: "乙級星" }, { key: "CD", front: "天刑", back: "乙級星" }, { key: "CE", front: "天姚", back: "乙級星" }, { key: "CF", front: "解神", back: "乙級星" }, { key: "CG", front: "天巫", back: "乙級星" }, { key: "CH", front: "天月", back: "乙級星" }, { key: "CI", front: "陰煞", back: "乙級星" }, { key: "CJ", front: "台輔", back: "乙級星" }, { key: "CK", front: "封誥", back: "乙級星" }, { key: "CL", front: "天空", back: "乙級星" }, { key: "CM", front: "天哭", back: "乙級星" }, { key: "CN", front: "天虛", back: "乙級星" }, { key: "CO", front: "龍池", back: "乙級星" }, { key: "CP", front: "鳳閣", back: "乙級星" }, { key: "CQ", front: "紅鸞", back: "乙級星" }, { key: "CR", front: "天喜", back: "乙級星" }, { key: "CS", front: "孤辰", back: "乙級星" }, { key: "CT", front: "寡宿", back: "乙級星" }, { key: "CU", front: "蜚廉", back: "乙級星" }, { key: "CV", front: "破碎", back: "乙級星" }, { key: "CW", front: "華蓋", back: "乙級星" }, { key: "CX", front: "咸池", back: "乙級星" }, { key: "CY", front: "天德", back: "乙級星" }, { key: "CZ", front: "月德", back: "乙級星" }, { key: "DA", front: "天才", back: "乙級星" }, { key: "DB", front: "天壽", back: "乙級星" }, { key: "DC", front: "三台", back: "乙級星" }, { key: "DD", front: "八座", back: "乙級星" }, { key: "DE", front: "恩光", back: "乙級星" }, { key: "DF", front: "天貴", back: "乙級星" } ] },
                        { round: "四", card_back_background_image: "images/back4.jpg", card_face_background_image: "images/face9.jpg", totalCards: 12, drawCount: 1, texts: [ { key: "EA", front: "長生", back: "宮位" }, { key: "EB", front: "沐浴", back: "宮位" }, { key: "EC", front: "冠帶", back: "宮位" }, { key: "ED", front: "臨官", back: "宮位" }, { key: "EE", front: "帝旺", back: "宮位" }, { key: "EF", front: "衰", back: "宮位" }, { key: "EG", front: "病", back: "宮位" }, { key: "EH", front: "死", back: "宮位" }, { key: "EI", front: "墓", back: "宮位" }, { key: "EJ", front: "絕", back: "宮位" }, { key: "EK", front: "胎", back: "宮位" }, { key: "EL", front: "養", back: "宮位" } ] }
                    ]
                };

                // --- Conversion Helpers ---
                const cardNameToKey = {};
                const cardKeyToCard = {};
                round_data.rounds.forEach(round => {
                    round.texts.forEach(text => {
                        cardNameToKey[text.front] = text.key;
                        cardKeyToCard[text.key] = { ...text, round: round.round };
                    });
                });
                const locationNameToKey = { '巳': '1', '午': '2', '未': '3', '申': '4', '辰': '5', '酉': '6', '卯': '7', '戌': '8', '寅': '9', '丑': '10', '子': '11', '亥': '12', '中間': 'center' };
                const locationKeyToName = Object.fromEntries(Object.entries(locationNameToKey).map(a => a.reverse()));

                function decode(str) { try { return decodeURIComponent(str || ''); } catch { return str || ''; } }
                function isBase64(str) { return /^[A-Za-z0-9+\/=]+$/.test(str) && str.length % 4 === 0; }

                // --- Parsers and Formatters ---

                // Parses Chinese text into a structured object
                function parseChineseFormat(text) {
                    const obj = {
                        cus_info: { divination_time: '', gender: '', cus_name: '', subject: '', content: '' },
                        result: ''
                    };
                    if (!text) return obj;

                    const lines = text.split('\n');
                    let isParsingContent = false;
                    let isParsingCards = false;
                    const cardResults = [];

                    for (const line of lines) {
                        if (line.startsWith('時間：')) obj.cus_info.divination_time = line.substring(3).trim();
                        else if (line.startsWith('類型：')) obj.cus_info.subject = line.substring(3).trim();
                        else if (line.startsWith('性別：')) obj.cus_info.gender = line.substring(3).trim();
                        else if (line.startsWith('姓名：')) obj.cus_info.cus_name = line.substring(3).trim();
                        else if (line.startsWith('題目：')) obj.cus_info.subject = line.substring(3).trim();
                        else if (line.startsWith('問題概述:')) {
                            isParsingContent = true;
                            isParsingCards = false;
                            obj.cus_info.content = '';
                        } else if (line.startsWith('抽牌呈現:')) {
                            isParsingContent = false;
                            isParsingCards = true;
                        } else if (isParsingContent) {
                            obj.cus_info.content += (obj.cus_info.content ? '\n' : '') + line;
                        } else if (isParsingCards) {
                            const match = line.match(/^\d+\.\s*(.+)在(.+)$/);
                            if (match) {
                                const cardFront = match[1].trim();
                                const locationName = match[2].trim();
                                const cardKey = cardNameToKey[cardFront];
                                const locationKey = locationNameToKey[locationName];
                                if (cardKey && locationKey) {
                                    cardResults.push(`${locationKey}-${cardKey}`);
                                }
                            }
                        }
                    }
                    obj.cus_info.content = obj.cus_info.content.trim();
                    if (cardResults.length > 0) {
                        obj.result = `1.0;${cardResults.join('-')}`;
                    }
                    return obj;
                }

                // Builds Chinese text from a structured object
                function buildOutput(obj) {
                    let output = '';
                    if (obj && obj.cus_info) {
                        const { divination_time, subject, gender, cus_name, content } = obj.cus_info;
                        output += `時間：${decode(divination_time)}
`;
                        output += `類型：${decode(subject)}
`;
                        output += `性別：${decode(gender)}
`;
                        output += `姓名：${decode(cus_name)}
`;
                        output += `題目：${decode(subject)}

`;
                        output += `問題概述:
${decode(content)}

`;
                    }
                    if (obj && obj.result) {
                        const [ver, ...rest] = obj.result.split(';');
                        const cards = [];
                        if (rest.length > 0) {
                            const arr = rest.join(';').split('-');
                            for (let i = 0; i < arr.length; i += 2) {
                                const location = arr[i];
                                const key = arr[i + 1] || '';
                                const card = cardKeyToCard[key];
                                const locationName = locationKeyToName[location];
                                if (card && locationName) {
                                    cards.push(`${cards.length + 1}. ${card.front}在${locationName}`);
                                }
                            }
                        }
                        output += `抽牌呈現:
${cards.join('\n')}`;
                    }
                    return output.trim() || null;
                }

                // --- Central Data Model ---
                const divinationData = ref({ cus_info: {}, result: '' });

                // --- Separate input and display states ---
                const rawInputText = ref('');
                
                // --- Writable Computed Properties for 2-way data binding ---
                const inputText = computed({
                    get() {
                        return rawInputText.value;
                    },
                    set(newValue) {
                        rawInputText.value = newValue;
                        // Parse different formats and update divinationData
                        if (!newValue) {
                            divinationData.value = { cus_info: {}, result: '' };
                            return;
                        }
                        
                        let obj;
                        try {
                            if (newValue.startsWith('{')) {
                                // JSON format
                                obj = JSON.parse(newValue);
                                divinationData.value = obj;
                            } else if (isBase64(newValue)) {
                                // Base64 format
                                obj = JSON.parse(atob(newValue));
                                divinationData.value = obj;
                            } else if (newValue.includes('時間：') || newValue.includes('抽牌呈現:')) {
                                // Chinese format
                                const parsed = parseChineseFormat(newValue);
                                const new_cus_info = {};
                                for (const key in parsed.cus_info) {
                                    new_cus_info[key] = encodeURIComponent(parsed.cus_info[key]);
                                }
                                divinationData.value = { cus_info: new_cus_info, result: parsed.result };
                            }
                            // If it's neither JSON, base64, nor Chinese format, don't update divinationData
                        } catch { 
                            // If parsing fails, don't update divinationData
                        }
                    }
                });

                const outputText = computed({
                    get() {
                        // If no input, return empty string
                        if (!rawInputText.value) {
                            return '';
                        }
                        // If input is Chinese format, display the input as-is
                        if (rawInputText.value.includes('時間：') || rawInputText.value.includes('抽牌呈現:')) {
                            return rawInputText.value;
                        }
                        // Otherwise, build output from divinationData
                        return buildOutput(divinationData.value) || '';
                    }
                    // Removed setter since output is now readonly
                });

                // --- Computed Properties for Display ---
                const customerInfo = computed(() => {
                    const info = divinationData.value.cus_info;
                    if (info && Object.values(info).some(v => v)) {
                        return {
                            gender: decode(info.gender),
                            cus_name: decode(info.cus_name),
                            subject: decode(info.subject),
                            content: decode(info.content),
                            divination_time: decode(info.divination_time)
                        };
                    }
                    return null;
                });

                const orderedCards = computed(() => {
                    const resultStr = divinationData.value.result;
                    if (!resultStr) return [];
                    const [ver, ...rest] = resultStr.split(';');
                    const allCards = [];
                    if (rest.length > 0) {
                        const arr = rest.join(';').split('-');
                        for (let i = 0; i < arr.length; i += 2) {
                            let locationKey = arr[i];
                            let cardKey = arr[i + 1] || '';
                            if (!cardKey) continue;
                            const card = cardKeyToCard[cardKey];
                            const locationName = locationKeyToName[locationKey];
                            if (card && locationName) {
                                allCards.push({ ...card, location: locationName });
                            }
                        }
                    }
                    return allCards;
                });

                const gridCards = computed(() => {
                    const grid = {};
                    orderedCards.value.forEach((card, index) => {
                        const location = card.location;
                        if (!grid[location]) {
                            grid[location] = [];
                        }
                        grid[location].push({ ...card, globalIndex: index + 1 });
                    });
                    return grid;
                });

                // --- UI Methods ---
                const clearInput = () => {
                    rawInputText.value = '';
                    divinationData.value = { cus_info: {}, result: '' };
                };

                const copyToClipboard = async () => {
                    if (!outputText.value) return;
                    try {
                        await navigator.clipboard.writeText(outputText.value);
                        copyButtonText.value = '已複製!';
                        copyIcon.value = 'check';
                    } catch (err) {
                        copyButtonText.value = '複製失敗';
                        copyIcon.value = 'fail';
                    } finally {
                        setTimeout(() => {
                            copyButtonText.value = '複製內容';
                            copyIcon.value = 'copy';
                        }, 1500);
                    }
                };

                return {
                    inputText,
                    outputText,
                    copyButtonText,
                    copyIcon,
                    copyButtonClass,
                    copyToClipboard,
                    clearInput,
                    gridCards,
                    customerInfo,
                    rawInputText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>